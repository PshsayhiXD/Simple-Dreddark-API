const root="undefined"!=typeof unsafeWindow?unsafeWindow:window,version="2.1.6",deprecate=e=>{console.warn("%cDEPRECATED%c "+e,"background:#ff3b3b;color:#fff;font-weight:bold;padding:2px 6px;border-radius:3px","color:inherit")};(()=>{"use strict";let e="?";const t={enabled:!1,log(...e){this.enabled&&console.log("[Dreddark]",...e)}},n={0:"guest",1:"crew",3:"captain",guest:0,crew:1,captain:3},s={defaultDatabase:"localstorage",namespace:"DreddarkAPI",readonly:!1,onError(e){},localstorage:{key:"persist"},sessionstorage:{key:"session"},memory:{},cookie:{key:"cookie",path:"/",maxAge:31536e3,sameSite:"Lax",secure:!1},url:{key:null,action:"query",replaceState:!0},indexeddb:{name:"DreddarkAPI",store:"kv"},broadcast:{channel:"DreddarkAPI"}},o=e=>{if(e||(e=s),"object"!=typeof e)return;const t=e.namespace||s.namespace,n=e=>({get(n){const s=e.get("__root__")||{};return((e,t)=>t.split(".").reduce((e,t)=>e?.[t],e))(t?s[t]||{}:s,n)},set(n,s){const o=e.get("__root__")||{};((e,t,n)=>{const s=t.split(".");let o=e;for(let e=0;e<s.length-1;e++)o=o[s[e]]||={};o[s.at(-1)]=n})(t?o[t]||={}:o,n,s),e.set("__root__",o)},del(n){const s=e.get("__root__")||{};((e,t)=>{const n=t.split(".");let s=e;for(let e=0;e<n.length-1;e++){if(!s[n[e]])return;s=s[n[e]]}delete s[n.at(-1)]})(t?s[t]||{}:s,n),e.set("__root__",s)}});if("localstorage"===e.defaultDatabase||"sessionstorage"===e.defaultDatabase){const t="sessionstorage"===e.defaultDatabase?sessionStorage:localStorage,s=e[e.defaultDatabase].key;return n({get(e){try{return JSON.parse(t.getItem(s))?.[e]}catch{return}},set(e,n){try{const o=JSON.parse(t.getItem(s))||{};o[e]=n,t.setItem(s,JSON.stringify(o))}catch{}},del(e){try{const n=JSON.parse(t.getItem(s))||{};delete n[e],t.setItem(s,JSON.stringify(n))}catch{}}})}if("memory"===e.defaultDatabase){const e={};return n({get:t=>e[t],set(t,n){e[t]=n},del(t){delete e[t]}})}if("cookie"===e.defaultDatabase){const t=e.cookie;return n({get:e=>document.cookie.split("; ").find(t=>t.startsWith(`${e}=`))?.split("=")[1],set(e,n){document.cookie=`${e}=${n}; path=${t.path}; max-age=${t.maxAge}`},del(e){document.cookie=`${e}=; path=${t.path}; max-age=0`}})}if("url"===e.defaultDatabase){const t=e.url;return n({get(e){const n=new URL(location.href),s=e??t.key;return"query"===t.action?n.searchParams.get(s):"hash"===t.action?new URLSearchParams(n.hash.slice(1)).get(s):"path"===t.action?n.pathname.split("/").pop():void 0},set(e,n){const s=new URL(location.href),o=e??t.key;if("query"===t.action&&s.searchParams.set(o,n),"hash"===t.action){const e=new URLSearchParams(s.hash.slice(1));e.set(o,n),s.hash=e.toString()}"path"===t.action&&(s.pathname=`${s.pathname.replace(/\/[^/]*$/,"")}/${n}`),history.replaceState(null,"",s.toString())},del(e){const n=new URL(location.href),s=e??t.key;if("query"===t.action&&n.searchParams.delete(s),"hash"===t.action){const e=new URLSearchParams(n.hash.slice(1));e.delete(s),n.hash=e.toString()}"path"===t.action&&(n.pathname=n.pathname.replace(/\/[^/]*$/,"")),history.replaceState(null,"",n.toString())}})}if("indexeddb"===e.defaultDatabase){const t=e.indexeddb;let s;const o=()=>s||=new Promise((e,n)=>{const s=indexedDB.open(t.name,1);s.onupgradeneeded=()=>s.result.createObjectStore(t.store),s.onsuccess=()=>e(s.result),s.onerror=()=>n(s.error)}),r=async(e,n,s)=>{const r=await o();return new Promise((o,a)=>{const i=r.transaction(t.store,e).objectStore(t.store)[e](s,n);i.onsuccess=()=>o(i.result),i.onerror=()=>a(i.error)})};return n({get:async e=>r("get",e),async set(e,t){await r("put",e,t)},async del(e){await r("delete",e)}})}if("broadcast"===e.defaultDatabase){const t=new BroadcastChannel(e.broadcast.channel),s={};return t.onmessage=e=>Object.assign(s,e.data),n({get:e=>s[e],set(e,n){s[e]=n,t.postMessage({[e]:n})},del(e){delete s[e],t.postMessage({[e]:void 0})}})}throw new Error("Invalid defaultDatabase")},r=o({...s}),a=(()=>{const e={};return{on(t,n){(e[t]||=[]).push(n)},emit(t,n){(e[t]||[]).forEach(e=>{try{e(n)}catch{}})}}})(),i={wait:(e,{timeout:t=1e4}={})=>new Promise((n,s)=>{const o=document.querySelector(e);if(o)return n(o);const r=new MutationObserver(()=>{const t=document.querySelector(e);t&&(a(),n(t))}),a=()=>{clearTimeout(i),r.disconnect()},i=setTimeout(()=>{a(),s(new Error(`observe.wait timeout: ${e}`))},t);r.observe(document,{childList:!0,subtree:!0})})},c={promote(e,t){if(!(t in n))return!1;const s=c.getUserContext(e);return!!s&&(!(s.currentRank>=t)&&(c.applyRank(s.select,t),!0))},demote(e,t){if(!(t in n))return!1;const s=c.getUserContext(e);return!!s&&(!(s.currentRank<=t)&&(c.applyRank(s.select,t),!0))},getUserContext(e){const t=document.getElementById("team_manager_button"),n=document.getElementById("team_menu");return t&&n?(t.click(),n.classList.add("hidden"),i.wait("#team_players_inner").then(()=>{const t=[...document.querySelectorAll("#team_players_inner td > code")].find(t=>t.textContent===e),n=t?.closest("tr")?.querySelector("select");return n?{select:n,currentRank:Number(n.value)}:null})):null},applyRank(e,t){e.value=t,e.dispatchEvent(new Event("change")),setTimeout(()=>{const e=document.getElementById("team_manager_button"),t=document.getElementById("team_menu");e&&t&&(t.classList.remove("hidden"),e.click())},250)},join(e){const t=[...document.querySelectorAll(".shipyard-item .sy-id")].find(t=>t.textContent===`{${e}}`),n=t?.closest(".shipyard-item");return!!n&&(n.click(),!0)},async getShipFromLink(e){try{const t=await fetch(e,{headers:{"User-Agent":"Mozilla/5.0",Cookie:"anon_key=fZEBE7fIFigqHKHPHiAzp0SW"}});if(!t.ok)return{};const n=await t.text(),s=n.match(/<meta\s+property=["']og:title["']\s+content=["']([^"']+)["']/i),o=n.match(/<meta\s+property=["']og:image["']\s+content=["']([^"']+)["']/i),r=s?s[1]:"",a=o?o[1]:null,i=r.replace(/^(Invite:|Ship:)\s*/i,"").replace(/\s*[-|]\s*drednot\.io$/i,"").trim();return i&&"Deep Space Airships"!==i?{valid:!0,shipName:i,shipImage:a}:{}}catch{return{}}},getCurrentJoinedShip:()=>r.session.get("ship.current")||null,initSaveJoinedShip(){const e=document.querySelector(".shipyard-bin");return!!e&&(e.addEventListener("click",e=>{const t=e.target.closest(".shipyard-item");if(!t)return;const n=t.querySelector(".sy-id");if(!n)return;const s=n.textContent.replace(/[{}]/g,""),o=t.querySelector(".sy-title h3")?.textContent||"",a=Number(t.querySelector(".sy-crew")?.textContent.replace(/\D+/g,""))||0,i=getComputedStyle(t);r.session.set("ship.current",{id:s,title:o,crew:a,backgroundColor:i.backgroundColor,backgroundImage:i.backgroundImage,joinedAt:Date.now(),node:t})}),!0)},clearCurrentShip(){r.session.delete("ship.current")}},l={validateName:e=>e.length>20?"NAME_TOO_LONG":e.length<3?"NAME_TOO_SHORT":e.startsWith(" ")?"STARTS_WITH_SPACE":e.endsWith(" ")?"ENDS_WITH_SPACE":e.includes("  ")?"DOUBLE_SPACE":/[^a-z0-9 ]/i.test(e)?"INVALID_CHARACTER":null},u={async accountInfo(){let e=null;try{const t=await fetch("https://drednot.io/account/status"),n=await t.json();e=n?.account?{name:n.account.name??null,isRegistered:!0===n.account.is_registered}:{name:null,isRegistered:!1}}catch{}return e},async getAccount(e){try{const t=await this.accountInfo();return t?.[e]??null}catch{return null}},async getClientUsername(){return await this.getAccount("name")},async isClientRegistered(){return!0===await this.getAccount("isRegistered")}},d=(()=>{const t={},s="persistCooldown",o=()=>Date.now(),i=e=>Dreddark.chat.send(`error: ${e}`);return a.on("chat",a=>{for(const c in t){const l=t[c],u=l.prefix||e;if(!a.message.startsWith(u))continue;const d=a.message.slice(u.length).trim();if(!d)continue;const m=d.split(/\s+/);if(m[0]!==c)continue;const g=m.slice(1);if(null!=l.rankRequire&&(n[a.role]??0)<l.rankRequire)return void i("insufficient rank");const p=`cmd:${c}:user:${a.user}`,h=`cmd:${c}:global`;if(l.sessionCooldown){const e=r.session.get(s,p)||0;if(e>o())return void i(`cooldown ${(e-o())/1e3|0}s`)}if(l.persistCooldown){const e=r.persist.get(s,p);if(e>o())return void i(`cooldown ${(e-o())/1e3|0}s`)}if(l.globalCooldown){const e=r.persist.get(s,h);if(e>o())return void i(`global cooldown ${(e-o())/1e3|0}s`)}if(l.args)for(let e=0;e<l.args.length;e++){const t=l.args[e],n=g[e];if(t.required&&null==n)return void i(`missing <${t.name}>`);if(null!=n&&t.validate){const e=t.validate(n,g);if(e)return void i(e)}}return l.run(a,g,user),l.sessionCooldown&&r.session.set(s,p,o()+l.sessionCooldown),l.persistCooldown&&r.persist.set(s,p,o()+l.persistCooldown),void(l.globalCooldown&&r.persist.set(s,h,o()+l.globalCooldown))}}),{register:(e,n)=>(t[e]=n,!0),setDefaultPrefix:t=>("string"==typeof t&&t.length&&(e=t),t)}})(),m=(()=>{const e=[];let n=!1;let s=null,o=!1;const r=()=>{!n&&e.length&&((()=>{const e=document.getElementById("chat"),t=document.getElementById("chat-send");e?.classList.contains("closed")&&t?.click()})(),requestAnimationFrame(()=>{const t=document.getElementById("chat-input"),s=document.getElementById("chat-send");if(!t||!s)return;n=!0;const o=t.maxLength>0?t.maxLength-3:247;let a=String(e.shift());a.length>o&&(a=a.slice(0,o)+"..."),t.focus(),t.value=a,t.dispatchEvent(new Event("input",{bubbles:!0})),s.click(),setTimeout(()=>{n=!1,r()},1e3)}))};return{send:t=>!!t&&(e.push(String(t)),r(),!0),init:async()=>{const e=await u.getClientUsername();if(o)return!1;o=!0;const n=await i.wait("#chat-content");return s=new MutationObserver(async n=>{for(const s of n)for(const n of s.addedNodes){if(!(n instanceof HTMLElement))continue;const s=n.querySelector("b");if(!s){t.log("skip: no <b>",n);continue}const o=s.querySelectorAll(".user-badge-small"),r=s.querySelectorAll("bdi"),i=s.querySelector("span"),c=s.textContent.replace(/\s+/g," ").trim(),l=[...n.childNodes].filter(e=>e.nodeType===Node.TEXT_NODE).map(e=>e.textContent).join("").trim(),u=s.classList.contains("warning")||c.startsWith("WARNING:"),d=!!r[0],m=c.includes(":"),g=d&&m&&!u,p=!g&&!u,h=g?r[0]?.textContent||"unknown":null,f=g?i?.textContent||"Guest":null,y={trusted:!1,timestamp:Date.now(),raw:c,isUser:g,isSystem:p};if(t.log("parsed",{userMessage:l,rawText:c,isUser:g,isSystem:p}),u)t.log("emit warning",y),a.emit("warning",y);else{if(p&&"SYSTEM"===i?.textContent&&c.includes("New mission:")){const e=c.includes("NOW"),n=c.split("New mission:")[1]?.split(".")[0]?.trim()||"",s=c.match(/in (.*?) (NOW|in)/)?.[1]||"";t.log("emit mission",{name:n,location:s,isOpen:e}),a.emit("mission",{...y,name:n,location:s,isOpen:e});continue}if(p&&(c.includes("was promoted to")||c.includes("was demoted to")))r.length>=2&&(t.log("emit roleChange",{targetUser:r[0].textContent,byUser:r[1].textContent}),a.emit("roleChange",{...y,targetUser:r[0].textContent,byUser:r[1].textContent,newRole:i?.textContent||null}));else{if(g){h===e&&await new Promise(e=>setTimeout(e,1e3));const n=o.length?[...o].map(e=>({img:e.querySelector("img")?.getAttribute("src")||null,text:e.querySelector(".tooltip")?.textContent.trim()||null})):[],s=l;if(!s){t.log("skip empty message",c);continue}t.log("emit chat",{user:h,role:f,message:s}),a.emit("chat",{...y,user:h,role:f,message:s,badges:n});continue}if(p&&c.includes("joined the ship.")){const e=r[0]?.textContent||"unknown";t.log("emit shipJoin",e),a.emit("shipJoin",{...y,user:e});continue}if(p&&c.includes("left the ship.")){const e=r[0]?.textContent||"unknown";t.log("emit shipLeave",e),a.emit("shipLeave",{...y,user:e});continue}t.log("unhandled line",c)}}}}),s.observe(n,{childList:!0}),!0},destroy:()=>!!o&&(s?.disconnect(),s=null,o=!1,!0)}})(),g=(()=>{deprecate("Outfit API is no longer work. please stop using it");let e=!1,t=null,n=null,s=!1,o=!1;return{initWsHook:r=>{if(deprecate("Outfit API is no longer work. please stop using it"),"loading"!==document.readyState)return;if(e)return;if("string"!=typeof r||!r)return;n=r,(()=>{if(window.msgpack)return void(s=!0);if(o)return;o=!0;const e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/@msgpack/msgpack/dist/msgpack.min.js",e.onload=()=>{s=!0},e.onerror=()=>{o=!1},document.documentElement.appendChild(e)})();const a=window.postMessage;window.postMessage=function(s,o,...r){return!e&&s?.message===n&&s?.wsData&&(t=e=>a.call(this,{message:n,wsData:e},o),e=!0),a.call(this,s,o,...r)},console.log(!0)},setOutfit:(n,o)=>{if(deprecate("Outfit API is no longer work. please stop using it"),!o||"object"!=typeof o)return;if(n){if(!e||!s)return;return t(window.msgpack.encode({type:7,outfit:o})),!0}const r=(()=>{try{return JSON.parse(localStorage.getItem("dredark_user_settings"))||{}}catch{return{}}})();return r.player_appearance=o,localStorage.setItem("dredark_user_settings",JSON.stringify(r)),!0}}})(),Dreddark={defaultCommandPrefix:e,version:"2.1.6",rankValue:n,debug:t,outfit:g,events:a,chat:m,ship:c,commands:d,observe:i,createStorage:o,defaultStorageOption:s,storage:r,utils:l,use(e){try{e(Dreddark)}catch{}},client:u};root.Dreddark=Dreddark})();