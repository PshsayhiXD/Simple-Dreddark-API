const root="undefined"!=typeof unsafeWindow?unsafeWindow:window,version="2.1.7",deprecate=e=>{console.warn("%cDEPRECATED%c "+e,"background:#ff3b3b;color:#fff;font-weight:bold;padding:2px 6px;border-radius:3px","color:inherit")};(()=>{"use strict";let e="?";const t={enabled:!1,log(...e){this.enabled&&console.log("[Dreddark]",...e)}},n={0:"guest",1:"crew",3:"captain",guest:0,crew:1,captain:3},s=(()=>{const e={};return Object.freeze({on(t,n){(e[t]||=[]).push(n)},emit(t,n){(e[t]||[]).forEach(e=>{try{e(n)}catch{}})}})})(),o=Object.freeze({wait:(e,{timeout:t=1e4}={})=>new Promise((n,s)=>{const o=document.querySelector(e);if(o)return n(o);const r=new MutationObserver(()=>{const t=document.querySelector(e);t&&(a(),n(t))}),a=()=>{clearTimeout(i),r.disconnect()},i=setTimeout(()=>{a(),s(new Error(`observe.wait timeout: ${e}`))},t);r.observe(document,{childList:!0,subtree:!0})})}),r=Object.freeze({validateName:e=>e.length>20?"NAME_TOO_LONG":e.length<3?"NAME_TOO_SHORT":e.startsWith(" ")?"STARTS_WITH_SPACE":e.endsWith(" ")?"ENDS_WITH_SPACE":e.includes("  ")?"DOUBLE_SPACE":/[^a-z0-9 ]/i.test(e)?"INVALID_CHARACTER":null,state:(e={})=>{const t={...e},n=new Map;return Object.freeze({get:e=>t[e],set:(e,s)=>{const o=t[e];if(Object.is(o,s))return;t[e]=s;const r=n.get(e);if(r)for(const e of r)e(s,o)},watch:(e,t)=>(n.has(e)||n.set(e,new Set),n.get(e).add(t),()=>n.get(e)?.delete(t)),snapshot:()=>({...t})})}}),a=(()=>{const e=async()=>{let e=null;try{const t=await fetch("https://drednot.io/account/status"),n=await t.json();e=n?.account?{name:n.account.name??null,isRegistered:!0===n.account.is_registered}:{name:null,isRegistered:!1}}catch{}return e},t=async t=>{try{const n=await e();return n?.[t]??null}catch{return null}};return Object.freeze({accountInfo:e,getAccount:t,getClientUsername:async()=>await t("name"),isClientRegistered:async()=>!0===await t("isRegistered")})})(),i=(()=>{const e=document.getElementById("team_manager_button"),t=document.getElementById("team_menu"),s=document.querySelector(".shipyard-bin"),r=document.getElementById("manager"),i=document.getElementById("chat-box"),l=document.getElementById("chat-btn"),u=document.getElementById("chat-input"),d=async n=>{if(!e||!t)return null;e.click(),t.classList.add("hidden"),await o.wait("#team_players_inner");const s=[...document.querySelectorAll("#team_players_inner td > code")].find(e=>e.textContent===n),r=s?.closest("tr")?.querySelector("select");return r?{select:r,currentRank:Number(r.value)}:null},m=(n,s)=>{n.value=s,n.dispatchEvent(new Event("change")),setTimeout(()=>{e&&t&&(t.classList.remove("hidden"),e.click())},250)};return Object.freeze({promote:async(e,t)=>{if(!(t in n))return!1;const s=await d(e);return!!s&&(!(s.currentRank>=t)&&(m(s.select,t),!0))},demote:async(e,t)=>{if(!(t in n))return!1;const s=await d(e);return!!s&&(!(s.currentRank<=t)&&(m(s.select,t),!0))},isClientCap:()=>""==r?.getAttribute("style"),getAllShipPlayer:()=>{i.classList.contains("closed")&&l.click(),u.value="/kick ",u.dispatchEvent(new Event("input"));const e=[...document.querySelectorAll("#chat-autocomplete p")].map(e=>e.textContent.replace(/\s+/g,""));document.querySelector("#chat-close").click();const t=a?a.replace(/\s+/g,""):"Unknown_Player";return e.length>0?[...e,t]:[t]},getUserContext:d,applyRank:m,join:e=>{const t=[...document.querySelectorAll(".shipyard-item .sy-id")].find(t=>t.textContent===`{${e}}`),n=t?.closest(".shipyard-item");return!!n&&(n.click(),!0)},getShipFromLink:async e=>{try{const t=await fetch(e,{headers:{"User-Agent":"Mozilla/5.0",Cookie:"anon_key=fZEBE7fIFigqHKHPHiAzp0SW"}});if(!t.ok)return{};const n=await t.text(),s=n.match(/<meta\s+property=["']og:title["']\s+content=["']([^"']+)["']/i),o=n.match(/<meta\s+property=["']og:image["']\s+content=["']([^"']+)["']/i),r=s?s[1]:"",a=o?o[1]:null,i=r.replace(/^(Invite:|Ship:)\s*/i,"").replace(/\s*[-|]\s*drednot\.io$/i,"").trim();return i&&"Deep Space Airships"!==i?{valid:!0,shipName:i,shipImage:a}:{}}catch{return{}}},fetchShipList:async()=>{try{const e=await fetch("https://drednot.io/shiplist?server=0",{headers:{"User-Agent":"Mozilla/5.0",Cookie:"anon_key=fZEBE7fIFigqHKHPHiAzp0SW"}});if(!e.ok)return null;const t=await e.json();return t.ships?t:null}catch{return null}},parseShipData:e=>{try{return e.ships?Object.entries(e.ships).map(([,e])=>({id:e.hex_code||"00000",title:e.team_name||"Unknown",color:e.color||"N/A",time:e.time||0,icon:e.icon_path||"",player_count:e.player_count||0})).sort((e,t)=>t.player_count-e.player_count):[]}catch(e){return console.error("Error processing ship data:",e.messasge),[]}},motdEdit:e=>(document.getElementById("motd-edit-button").click(),document.getElementById("motd-edit-text").value=e,saveMotd(!0),!0),getCurrentJoinedShip:()=>c.session.get("ship.current")||null,initSaveJoinedShip:()=>!!s&&(s.addEventListener("click",e=>{const t=e.target.closest(".shipyard-item");if(!t)return;const n=t.querySelector(".sy-id");if(!n)return;const s=n.textContent.replace(/[{}]/g,""),o=t.querySelector(".sy-title h3")?.textContent||"",r=Number(t.querySelector(".sy-crew")?.textContent.replace(/\D+/g,""))||0,a=getComputedStyle(t);c.session.set("ship.current",{id:s,title:o,crew:r,backgroundColor:a.backgroundColor,backgroundImage:a.backgroundImage,joinedAt:Date.now(),node:t})}),!0),clearCurrentShip:()=>{c.session.delete("ship.current")}})})(),c=(()=>{const e={defaultDatabase:"localstorage",namespace:"DreddarkAPI",readonly:!1,onError(e){},localstorage:{key:"persist"},sessionstorage:{key:"session"},memory:{},cookie:{key:"cookie",path:"/",maxAge:31536e3,sameSite:"Lax",secure:!1},url:{key:null,action:"query",replaceState:!0},indexeddb:{name:"DreddarkAPI",store:"kv"},broadcast:{channel:"DreddarkAPI"}},t=t=>{if(t||(t=e),"object"!=typeof t)return;const n=t.namespace||e.namespace,s=e=>({get(t){const s=e.get("__root__")||{};return((e,t)=>t.split(".").reduce((e,t)=>e?.[t],e))(n?s[n]||{}:s,t)},set(t,s){const o=e.get("__root__")||{};((e,t,n)=>{const s=t.split(".");let o=e;for(let e=0;e<s.length-1;e++)o=o[s[e]]||={};o[s.at(-1)]=n})(n?o[n]||={}:o,t,s),e.set("__root__",o)},del(t){const s=e.get("__root__")||{};((e,t)=>{const n=t.split(".");let s=e;for(let e=0;e<n.length-1;e++){if(!s[n[e]])return;s=s[n[e]]}delete s[n.at(-1)]})(n?s[n]||{}:s,t),e.set("__root__",s)}});if("localstorage"===t.defaultDatabase||"sessionstorage"===t.defaultDatabase){const e="sessionstorage"===t.defaultDatabase?sessionStorage:localStorage,n=t[t.defaultDatabase].key;return s({get(t){try{return JSON.parse(e.getItem(n))?.[t]}catch{return}},set(t,s){try{const o=JSON.parse(e.getItem(n))||{};o[t]=s,e.setItem(n,JSON.stringify(o))}catch{}},del(t){try{const s=JSON.parse(e.getItem(n))||{};delete s[t],e.setItem(n,JSON.stringify(s))}catch{}}})}if("memory"===t.defaultDatabase){const e={};return s({get:t=>e[t],set(t,n){e[t]=n},del(t){delete e[t]}})}if("cookie"===t.defaultDatabase){const e=t.cookie;return s({get:e=>document.cookie.split("; ").find(t=>t.startsWith(`${e}=`))?.split("=")[1],set(t,n){document.cookie=`${t}=${n}; path=${e.path}; max-age=${e.maxAge}`},del(t){document.cookie=`${t}=; path=${e.path}; max-age=0`}})}if("url"===t.defaultDatabase){const e=t.url;return s({get(t){const n=new URL(location.href),s=t??e.key;return"query"===e.action?n.searchParams.get(s):"hash"===e.action?new URLSearchParams(n.hash.slice(1)).get(s):"path"===e.action?n.pathname.split("/").pop():void 0},set(t,n){const s=new URL(location.href),o=t??e.key;if("query"===e.action&&s.searchParams.set(o,n),"hash"===e.action){const e=new URLSearchParams(s.hash.slice(1));e.set(o,n),s.hash=e.toString()}"path"===e.action&&(s.pathname=`${s.pathname.replace(/\/[^/]*$/,"")}/${n}`),history.replaceState(null,"",s.toString())},del(t){const n=new URL(location.href),s=t??e.key;if("query"===e.action&&n.searchParams.delete(s),"hash"===e.action){const e=new URLSearchParams(n.hash.slice(1));e.delete(s),n.hash=e.toString()}"path"===e.action&&(n.pathname=n.pathname.replace(/\/[^/]*$/,"")),history.replaceState(null,"",n.toString())}})}if("indexeddb"===t.defaultDatabase){const e=t.indexeddb;let n;const o=()=>n||=new Promise((t,n)=>{const s=indexedDB.open(e.name,1);s.onupgradeneeded=()=>s.result.createObjectStore(e.store),s.onsuccess=()=>t(s.result),s.onerror=()=>n(s.error)}),r=async(t,n,s)=>{const r=await o();return new Promise((o,a)=>{const i=r.transaction(e.store,t).objectStore(e.store)[t](s,n);i.onsuccess=()=>o(i.result),i.onerror=()=>a(i.error)})};return s({get:async e=>r("get",e),async set(e,t){await r("put",e,t)},async del(e){await r("delete",e)}})}if("broadcast"===t.defaultDatabase){const e=new BroadcastChannel(t.broadcast.channel),n={};return e.onmessage=e=>Object.assign(n,e.data),s({get:e=>n[e],set(t,s){n[t]=s,e.postMessage({[t]:s})},del(t){delete n[t],e.postMessage({[t]:void 0})}})}throw new Error("Invalid defaultDatabase")},n=t({...e});return Object.freeze({storageOption:e,createStorage:t,defaultStorage:n})})(),l=(()=>{const t={},o="persistCooldown",r=()=>Date.now(),a=e=>Dreddark.chat.send(`error: ${e}`);return s.on("chat",s=>{for(const i in t){const l=t[i],u=l.prefix||e;if(!s.message.startsWith(u))continue;const d=s.message.slice(u.length).trim();if(!d)continue;const m=d.split(/\s+/);if(m[0]!==i)continue;const p=m.slice(1);if(null!=l.rankRequire&&(n[s.role]??0)<l.rankRequire)return void a("insufficient rank");const g=`cmd:${i}:user:${s.user}`,h=`cmd:${i}:global`;if(l.sessionCooldown){const e=c.session.get(o,g)||0;if(e>r())return void a(`cooldown ${(e-r())/1e3|0}s`)}if(l.persistCooldown){const e=c.persist.get(o,g);if(e>r())return void a(`cooldown ${(e-r())/1e3|0}s`)}if(l.globalCooldown){const e=c.persist.get(o,h);if(e>r())return void a(`global cooldown ${(e-r())/1e3|0}s`)}if(l.args)for(let e=0;e<l.args.length;e++){const t=l.args[e],n=p[e];if(t.required&&null==n)return void a(`missing <${t.name}>`);if(null!=n&&t.validate){const e=t.validate(n,p);if(e)return void a(e)}}return l.run(s,p,user),l.sessionCooldown&&c.session.set(o,g,r()+l.sessionCooldown),l.persistCooldown&&c.persist.set(o,g,r()+l.persistCooldown),void(l.globalCooldown&&c.persist.set(o,h,r()+l.globalCooldown))}}),Object.freeze({register:(e,n)=>(t[e]=n,!0),setDefaultPrefix:t=>("string"==typeof t&&t.length&&(e=t),t),getDefaultPrefix:()=>e})})(),u=(()=>{const e=1756201238,t=900,n=2700,o={source:"timer",isOpen:!1,name:null,location:null,openAt:null,closeAt:null,lastChatTs:0},r=()=>Math.floor(Date.now()/1e3);return s.on("mission",e=>{o.source="chat",o.isOpen=!0===e.isOpen,o.name=e.name||null,o.location=e.location||null,o.openAt=e.isOpen?e.timestamp:null,o.closeAt=null,o.lastChatTs=e.timestamp}),Object.freeze({getState:()=>{if("chat"===o.source)return Object.freeze({...o});const s=(()=>{const s=r();if(s<e)return{isOpen:!1,openAt:e,closeAt:1756202138};const o=Math.max(0,(s-e)%n);if(o<t)return{isOpen:!0,openAt:s-o,closeAt:s+(t-o)};const a=s+(n-o);return{isOpen:!1,openAt:a,closeAt:a+t}})();return Object.freeze({source:"timer",isOpen:s.isOpen,openAt:s.openAt,closeAt:s.closeAt,name:null,location:null})},getFuture:()=>{const s=r(),o=Math.floor(Math.max(0,(s-e)/n));let a=e+o*n;a<=s&&(a+=n);const i=[];for(let e=0;e<5;e++){const s=a+e*n;i.push(Object.freeze({openAt:s,closeAt:s+t}))}return Object.freeze(i)}})})(),d=(()=>{const e=[];let n=!1;let r=null,i=!1;const c=document.getElementById("chat"),l=document.getElementById("chat-send"),u=document.getElementById("chat-input"),d=()=>{!n&&e.length&&(c?.classList.contains("closed")&&l?.click(),requestAnimationFrame(()=>{if(!u||!l)return;n=!0;const t=u.maxLength>0?u.maxLength-3:247;let s=String(e.shift());s.length>t&&(s=s.slice(0,t)+"..."),u.focus(),u.value=s,u.dispatchEvent(new Event("input",{bubbles:!0})),l.click(),setTimeout(()=>{n=!1,d()},1e3)}))};return Object.freeze({send:t=>!!t&&(e.push(String(t)),d(),!0),init:async()=>{const e=await a.getClientUsername();if(i)return!1;i=!0;const n=await o.wait("#chat-content");return r=new MutationObserver(async n=>{for(const o of n)for(const n of o.addedNodes){if(!(n instanceof HTMLElement))continue;const o=n.querySelector("b");if(!o){t.log("skip: no <b>",n);continue}const r=o.querySelectorAll(".user-badge-small"),a=r.length?[...r].map(e=>({img:e.querySelector("img")?.getAttribute("src")||null,text:e.querySelector(".tooltip")?.textContent.trim()||null})):[],i=o.querySelectorAll("bdi"),c=o.querySelector("span"),l=o.textContent.replace(/\s+/g," ").trim(),u=[...n.childNodes].filter(e=>e.nodeType===Node.TEXT_NODE).map(e=>e.textContent).join("").trim(),d=o.classList.contains("warning")||l.startsWith("WARNING:"),m=!!i[0],p=l.includes(":"),g=m&&p&&!d,h=!g&&!d,f=g?i[0]?.textContent||"unknown":null,y=g?c?.textContent||"Guest":null,w={trusted:!1,timestamp:Date.now(),raw:l,isUser:g,isSystem:h};if(t.log("parsed",{userMessage:u,rawText:l,isUser:g,isSystem:h}),d)t.log("emit warning",w),s.emit("warning",w);else{if(h&&"SYSTEM"===c?.textContent&&l.includes("New mission:")){const e=l.includes("NOW"),n=l.split("New mission:")[1]?.split(".")[0]?.trim()||"",o=l.match(/in (.*?) (NOW|in)/)?.[1]||"";t.log("emit mission",{name:n,location:o,isOpen:e}),s.emit("mission",{...w,name:n,location:o,isOpen:e});continue}if(h&&(l.includes("was promoted to")||l.includes("was demoted to")))i.length>=2&&(t.log("emit roleChange",{targetUser:i[0].textContent,byUser:i[1].textContent}),s.emit("roleChange",{...w,targetUser:i[0].textContent,byUser:i[1].textContent,newRole:c?.textContent||null}));else{if(g){f===e&&await new Promise(e=>setTimeout(e,1e3));const n=u;if(!n){t.log("skip empty message",l);continue}t.log("emit chat",{user:f,role:y,message:n}),s.emit("chat",{...w,user:f,role:y,message:n,badges:a});continue}if(h&&l.includes("joined the ship.")){const e=i[0]?.textContent||"unknown";t.log("emit shipJoin",e),s.emit("shipJoin",{...w,user:e,role:y,badges:a});continue}if(h&&l.includes("left the ship.")){const e=i[0]?.textContent||"unknown";t.log("emit shipLeave",e),s.emit("shipLeave",{...w,user:e,role:y,badges:a});continue}t.log("unhandled line",l)}}}}),r.observe(n,{childList:!0}),!0},destroy:()=>!!i&&(r?.disconnect(),r=null,i=!1,!0)})})(),m=(()=>{deprecate("Outfit API is no longer work. please stop using it");let e=!1,t=null,n=null,s=!1,o=!1;return Object.freeze({initWsHook:r=>{if(deprecate("Outfit API is no longer work. please stop using it"),"loading"!==document.readyState)return;if(e)return;if("string"!=typeof r||!r)return;n=r,(()=>{if(window.msgpack)return void(s=!0);if(o)return;o=!0;const e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/@msgpack/msgpack/dist/msgpack.min.js",e.onload=()=>{s=!0},e.onerror=()=>{o=!1},document.documentElement.appendChild(e)})();const a=window.postMessage;window.postMessage=function(s,o,...r){return!e&&s?.message===n&&s?.wsData&&(t=e=>a.call(this,{message:n,wsData:e},o),e=!0),a.call(this,s,o,...r)},console.log(!0)},setOutfit:(n,o)=>{if(deprecate("Outfit API is no longer work. please stop using it"),!o||"object"!=typeof o)return;if(n){if(!e||!s)return;return t(window.msgpack.encode({type:7,outfit:o})),!0}const r=(()=>{try{return JSON.parse(localStorage.getItem("dredark_user_settings"))||{}}catch{return{}}})();return r.player_appearance=o,localStorage.setItem("dredark_user_settings",JSON.stringify(r)),!0}})})(),Dreddark={defaultCommandPrefix:e,version:"2.1.7",rankValue:n,debug:t,outfit:m,events:s,chat:d,ship:i,commands:l,mission:u,observe:o,defaultStorageOption:c.storageOption,storage:c,utils:r,use(e){try{e(Dreddark)}catch{}},client:a};root.Dreddark=Dreddark})();