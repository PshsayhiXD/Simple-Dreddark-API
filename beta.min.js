const root="undefined"!=typeof unsafeWindow?unsafeWindow:window,version="2.1.9",deprecate=e=>{console.warn("%cDEPRECATED%c "+e,"background:#ff3b3b;color:#fff;font-weight:bold;padding:2px 6px;border-radius:3px","color:inherit")};(()=>{"use strict";let e="?";const t={enabled:!1,log(...e){this.enabled&&console.log("[Dreddark]",...e)}},n={0:"guest",1:"crew",3:"captain",guest:0,crew:1,captain:3},o=(()=>{const e={};return Object.freeze({on(t,n){(e[t]||=[]).push(n)},emit(t,n){(e[t]||[]).forEach(e=>{try{e(n)}catch{}})}})})(),s=Object.freeze({wait:(e,{timeout:t=1e4}={})=>new Promise((n,o)=>{const s=document.querySelector(e);if(s)return n(s);const r=new MutationObserver(()=>{const t=document.querySelector(e);t&&(a(),n(t))}),a=()=>{clearTimeout(i),r.disconnect()},i=setTimeout(()=>{a(),o(new Error(`observe.wait timeout: ${e}`))},t);r.observe(document,{childList:!0,subtree:!0})})}),r=Object.freeze({validateName:e=>e.length>20?"NAME_TOO_LONG":e.length<3?"NAME_TOO_SHORT":e.startsWith(" ")?"STARTS_WITH_SPACE":e.endsWith(" ")?"ENDS_WITH_SPACE":e.includes("  ")?"DOUBLE_SPACE":/[^a-z0-9 ]/i.test(e)?"INVALID_CHARACTER":null,state:(e={})=>{const t={...e},n=new Map;return Object.freeze({get:e=>t[e],set:(e,o)=>{const s=t[e];if(Object.is(s,o))return;t[e]=o;const r=n.get(e);if(r)for(const e of r)e(o,s)},watch:(e,t)=>(n.has(e)||n.set(e,new Set),n.get(e).add(t),()=>n.get(e)?.delete(t)),snapshot:()=>({...t})})}}),a=(()=>{const e=async()=>{let e=null;try{const t=await fetch("https://drednot.io/account/status"),n=await t.json();e=n?.account?{name:n.account.name??null,isRegistered:!0===n.account.is_registered}:{name:null,isRegistered:!1}}catch{}return e},t=async t=>{try{const n=await e();return n?.[t]??null}catch{return null}};return Object.freeze({accountInfo:e,getAccount:t,getClientUsername:async()=>await t("name"),isClientRegistered:async()=>!0===await t("isRegistered")})})(),i=(()=>{const e=document.getElementById("team_manager_button"),t=document.getElementById("team_menu"),o=document.querySelector(".shipyard-bin"),r=document.getElementById("manager"),i=document.getElementById("chat-box"),l=document.getElementById("chat-btn"),u=document.getElementById("chat-input"),d=async n=>{if(!e||!t)return null;e.click(),t.classList.add("hidden"),await s.wait("#team_players_inner");const o=[...document.querySelectorAll("#team_players_inner td > code")].find(e=>e.textContent===n),r=o?.closest("tr")?.querySelector("select");return r?{select:r,currentRank:Number(r.value)}:null},p=(n,o)=>{n.value=o,n.dispatchEvent(new Event("change")),setTimeout(()=>{e&&t&&(t.classList.remove("hidden"),e.click())},250)};return Object.freeze({promote:async(e,t)=>{if(!(t in n))return!1;const o=await d(e);return!!o&&(!(o.currentRank>=t)&&(p(o.select,t),!0))},demote:async(e,t)=>{if(!(t in n))return!1;const o=await d(e);return!!o&&(!(o.currentRank<=t)&&(p(o.select,t),!0))},isClientCap:()=>""==r?.getAttribute("style"),getAllShipPlayer:()=>{i.classList.contains("closed")&&l.click(),u.value="/kick ",u.dispatchEvent(new Event("input"));const e=[...document.querySelectorAll("#chat-autocomplete p")].map(e=>e.textContent.replace(/\s+/g,""));document.querySelector("#chat-close").click();const t=a?a.replace(/\s+/g,""):"Unknown_Player";return e.length>0?[...e,t]:[t]},getUserContext:d,applyRank:p,join:e=>{const t=[...document.querySelectorAll(".shipyard-item .sy-id")].find(t=>t.textContent===`{${e}}`),n=t?.closest(".shipyard-item");return!!n&&(n.click(),!0)},getShipFromLink:async e=>{try{const t=await fetch(e,{headers:{"User-Agent":"Mozilla/5.0",Cookie:"anon_key=fZEBE7fIFigqHKHPHiAzp0SW"}});if(!t.ok)return{};const n=await t.text(),o=n.match(/<meta\s+property=["']og:title["']\s+content=["']([^"']+)["']/i),s=n.match(/<meta\s+property=["']og:image["']\s+content=["']([^"']+)["']/i),r=o?o[1]:"",a=s?s[1]:null,i=r.replace(/^(Invite:|Ship:)\s*/i,"").replace(/\s*[-|]\s*drednot\.io$/i,"").trim();return i&&"Deep Space Airships"!==i?{valid:!0,shipName:i,shipImage:a}:{}}catch{return{}}},fetchShipList:async()=>{try{const e=await fetch("https://drednot.io/shiplist?server=0",{headers:{"User-Agent":"Mozilla/5.0",Cookie:"anon_key=fZEBE7fIFigqHKHPHiAzp0SW"}});if(!e.ok)return null;const t=await e.json();return t.ships?t:null}catch{return null}},parseShipData:e=>{try{return e.ships?Object.entries(e.ships).map(([,e])=>({id:e.hex_code||"00000",title:e.team_name||"Unknown",color:e.color||"N/A",time:e.time||0,icon:e.icon_path||"",player_count:e.player_count||0})).sort((e,t)=>t.player_count-e.player_count):[]}catch(e){return console.error("Error processing ship data:",e.messasge),[]}},motdEdit:e=>(document.getElementById("motd-edit-button").click(),document.getElementById("motd-edit-text").value=e,saveMotd(!0),!0),getCurrentJoinedShip:()=>c.session.get("ship.current")||null,initSaveJoinedShip:()=>!!o&&(o.addEventListener("click",e=>{const t=e.target.closest(".shipyard-item");if(!t)return;const n=t.querySelector(".sy-id");if(!n)return;const o=n.textContent.replace(/[{}]/g,""),s=t.querySelector(".sy-title h3")?.textContent||"",r=Number(t.querySelector(".sy-crew")?.textContent.replace(/\D+/g,""))||0,a=getComputedStyle(t);c.session.set("ship.current",{id:o,title:s,crew:r,backgroundColor:a.backgroundColor,backgroundImage:a.backgroundImage,joinedAt:Date.now(),node:t})}),!0),clearCurrentShip:()=>{c.session.delete("ship.current")}})})(),c=(()=>{const e={defaultDatabase:"localstorage",namespace:"DreddarkAPI",readonly:!1,onError(e){},localstorage:{key:"persist"},sessionstorage:{key:"session"},memory:{},cookie:{key:"cookie",path:"/",maxAge:31536e3,sameSite:"Lax",secure:!1},url:{key:null,action:"query",replaceState:!0},indexeddb:{name:"DreddarkAPI",store:"kv"},broadcast:{channel:"DreddarkAPI"}},t=t=>{if(t||(t=e),"object"!=typeof t)return;const n=t.namespace||e.namespace,o=e=>({get(t){const o=e.get("__root__")||{};return((e,t)=>t.split(".").reduce((e,t)=>e?.[t],e))(n?o[n]||{}:o,t)},set(t,o){const s=e.get("__root__")||{};((e,t,n)=>{const o=t.split(".");let s=e;for(let e=0;e<o.length-1;e++)s=s[o[e]]||={};s[o.at(-1)]=n})(n?s[n]||={}:s,t,o),e.set("__root__",s)},del(t){const o=e.get("__root__")||{};((e,t)=>{const n=t.split(".");let o=e;for(let e=0;e<n.length-1;e++){if(!o[n[e]])return;o=o[n[e]]}delete o[n.at(-1)]})(n?o[n]||{}:o,t),e.set("__root__",o)}});if("localstorage"===t.defaultDatabase||"sessionstorage"===t.defaultDatabase){const e="sessionstorage"===t.defaultDatabase?sessionStorage:localStorage,n=t[t.defaultDatabase].key;return o({get(t){try{return JSON.parse(e.getItem(n))?.[t]}catch{return}},set(t,o){try{const s=JSON.parse(e.getItem(n))||{};s[t]=o,e.setItem(n,JSON.stringify(s))}catch{}},del(t){try{const o=JSON.parse(e.getItem(n))||{};delete o[t],e.setItem(n,JSON.stringify(o))}catch{}}})}if("memory"===t.defaultDatabase){const e={};return o({get:t=>e[t],set(t,n){e[t]=n},del(t){delete e[t]}})}if("cookie"===t.defaultDatabase){const e=t.cookie;return o({get:e=>document.cookie.split("; ").find(t=>t.startsWith(`${e}=`))?.split("=")[1],set(t,n){document.cookie=`${t}=${n}; path=${e.path}; max-age=${e.maxAge}`},del(t){document.cookie=`${t}=; path=${e.path}; max-age=0`}})}if("url"===t.defaultDatabase){const e=t.url;return o({get(t){const n=new URL(location.href),o=t??e.key;return"query"===e.action?n.searchParams.get(o):"hash"===e.action?new URLSearchParams(n.hash.slice(1)).get(o):"path"===e.action?n.pathname.split("/").pop():void 0},set(t,n){const o=new URL(location.href),s=t??e.key;if("query"===e.action&&o.searchParams.set(s,n),"hash"===e.action){const e=new URLSearchParams(o.hash.slice(1));e.set(s,n),o.hash=e.toString()}"path"===e.action&&(o.pathname=`${o.pathname.replace(/\/[^/]*$/,"")}/${n}`),history.replaceState(null,"",o.toString())},del(t){const n=new URL(location.href),o=t??e.key;if("query"===e.action&&n.searchParams.delete(o),"hash"===e.action){const e=new URLSearchParams(n.hash.slice(1));e.delete(o),n.hash=e.toString()}"path"===e.action&&(n.pathname=n.pathname.replace(/\/[^/]*$/,"")),history.replaceState(null,"",n.toString())}})}if("indexeddb"===t.defaultDatabase){const e=t.indexeddb;let n;const s=()=>n||=new Promise((t,n)=>{const o=indexedDB.open(e.name,1);o.onupgradeneeded=()=>o.result.createObjectStore(e.store),o.onsuccess=()=>t(o.result),o.onerror=()=>n(o.error)}),r=async(t,n,o)=>{const r=await s();return new Promise((s,a)=>{const i=r.transaction(e.store,t).objectStore(e.store)[t](o,n);i.onsuccess=()=>s(i.result),i.onerror=()=>a(i.error)})};return o({get:async e=>r("get",e),async set(e,t){await r("put",e,t)},async del(e){await r("delete",e)}})}if("broadcast"===t.defaultDatabase){const e=new BroadcastChannel(t.broadcast.channel),n={};return e.onmessage=e=>Object.assign(n,e.data),o({get:e=>n[e],set(t,o){n[t]=o,e.postMessage({[t]:o})},del(t){delete n[t],e.postMessage({[t]:void 0})}})}throw new Error("Invalid defaultDatabase")},n=t({...e});return Object.freeze({storageOption:e,createStorage:t,defaultStorage:n})})(),l=(()=>{const t={},s="persistCooldown",r=()=>Date.now(),a=e=>Dreddark.chat.send(`error: ${e}`);return o.on("chat",o=>{for(const i in t){const l=t[i],u=l.prefix||e;if(!o.message.startsWith(u))continue;const d=o.message.slice(u.length).trim();if(!d)continue;const p=d.split(/\s+/);if(p[0]!==i)continue;const m=p.slice(1);if(null!=l.rankRequire&&(n[o.role]??0)<l.rankRequire)return void a("insufficient rank");const g=`cmd:${i}:user:${o.user}`,h=`cmd:${i}:global`;if(l.sessionCooldown){const e=c.session.get(s,g)||0;if(e>r())return void a(`cooldown ${(e-r())/1e3|0}s`)}if(l.persistCooldown){const e=c.persist.get(s,g);if(e>r())return void a(`cooldown ${(e-r())/1e3|0}s`)}if(l.globalCooldown){const e=c.persist.get(s,h);if(e>r())return void a(`global cooldown ${(e-r())/1e3|0}s`)}if(l.args)for(let e=0;e<l.args.length;e++){const t=l.args[e],n=m[e];if(t.required&&null==n)return void a(`missing <${t.name}>`);if(null!=n&&t.validate){const e=t.validate(n,m);if(e)return void a(e)}}return l.run(o,m,user),l.sessionCooldown&&c.session.set(s,g,r()+l.sessionCooldown),l.persistCooldown&&c.persist.set(s,g,r()+l.persistCooldown),void(l.globalCooldown&&c.persist.set(s,h,r()+l.globalCooldown))}}),Object.freeze({register:(e,n)=>(t[e]=n,!0),setDefaultPrefix:t=>("string"==typeof t&&t.length&&(e=t),t),getDefaultPrefix:()=>e})})(),u=(()=>{const e=1756201238,t=900,n=2700,s={source:"timer",isOpen:!1,name:null,location:null,openAt:null,closeAt:null,lastChatTs:0},r=()=>Math.floor(Date.now()/1e3);return o.on("mission",e=>{s.name=e.name||null,s.location=e.location||null,s.lastChatTs=Math.floor(e.timestamp/1e3)}),Object.freeze({getFutureMissions:o=>{const s=r(),a=Math.floor(Math.max(0,(s-e)/n));let i=e+a*n;i<=s&&(i+=n);const c=[];for(let e=0;e<o;e++){const o=i+e*n;c.push(Object.freeze({openAt:o,closeAt:o+t}))}return Object.freeze(c)},getMissionState:()=>{if("chat"===s.source)return Object.freeze({...s});const o=(()=>{const o=r();if(o<e)return{isOpen:!1,openAt:e,closeAt:1756202138};const s=Math.max(0,(o-e)%n);if(s<t)return{isOpen:!0,openAt:o-s,closeAt:o+(t-s)};const a=o+(n-s);return{isOpen:!1,openAt:a,closeAt:a+t}})();return Object.freeze({source:"timer",isOpen:o.isOpen,openAt:o.openAt,closeAt:o.closeAt,name:null,location:null})}})})(),d=(()=>{let e="";const t=async()=>{try{const t=await fetch("https://drednot.io/pvp-events",{headers:{Accept:"application/json"}});if(!t.ok)throw new Error("An network error occur while fetching pvpEvent Schedule.");const n=(await t.text()).match(/<script[^>]*>(.*?)<\/script>/g).find(e=>e.includes("SCHEDULE="));e=JSON.parse(n.replace(/<script[^>]*>|<\/script>/g,"").trim().replace("SCHEDULE=",""))}catch{e=""}};return Object.freeze({fetchSchedule:t,pvpEvent:async n=>{await t(),"object"==typeof n?n=JSON.stringify(n):Array.isArray(n)&&(n=n.join(" ")),"string"==typeof n&&(n=n.toLowerCase());const o=new Date,s=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];if("all"===n)return e.map(({date:e})=>({date:e}));if("today"===n){const t=(new Date).setHours(0,0,0,0),n=e.filter(({date:e})=>new Date(e).setHours(0,0,0,0)===t);return n.length?n.map(({date:e})=>e):Error("No events for today.")}if(["next","second","third","four"].includes(n)){const t=e.filter(({date:e})=>new Date(e)>o).sort((e,t)=>new Date(e.date)-new Date(t.date)),s="next"===n?0:"second"===n?1:"third"===n?2:3;return t[s]?t[s].date:Error("No upcoming events.")}if(s.includes(n)){const t=e.filter(({date:e})=>new Date(e).getDay()===s.indexOf(n));return t.length?t.map(({date:e})=>e):Error(`No events found for ${n}`)}const r=e.filter(({date:e})=>e===n);r.length?r.map(({date:e})=>e):Error(`No events found for ${n}`)}})})(),p=(()=>{const e=[];let n=!1;let r=null,i=!1;const c=document.getElementById("chat"),l=document.getElementById("chat-send"),u=document.getElementById("chat-input"),d=()=>{!n&&e.length&&(c?.classList.contains("closed")&&l?.click(),requestAnimationFrame(()=>{if(!u||!l)return;n=!0;const t=u.maxLength>0?u.maxLength-3:247;let o=String(e.shift());o.length>t&&(o=o.slice(0,t)+"..."),u.focus(),u.value=o,u.dispatchEvent(new Event("input",{bubbles:!0})),l.click(),setTimeout(()=>{n=!1,d()},1e3)}))};return Object.freeze({send:t=>!!t&&(e.push(String(t)),d(),!0),waitForChat:(e,t,n={})=>{if("function"!=typeof n.onMatch)throw new Error("waitForChat: onMatch callback is required");const s=!!n.recallable,r=n.timeout??15,a=n.onMatch,i="function"==typeof n.onFallback?n.onFallback:null,c="*"===e,l="*"===t,u="function"==typeof t;let d,p,m=!1,g=!1,h=null;const f=async n=>{m||await(async n=>!(!c&&n.user!==e||!l&&(u?!await t(n.message,n):n.message!==t)))(n)&&(g=!0,a(n),s||(m=!0,y(),d?.(n)))},y=()=>{o.off("chat",f),h&&clearTimeout(h)};return r!==1/0&&(h=setTimeout(()=>{m=!0,y(),g||i?.(),p?.(new Error("waitForChat timeout"))},1e3*r)),s?(o.on("chat",f),y):new Promise((e,t)=>{d=e,p=t,o.on("chat",f)})},init:async()=>{const e=await a.getClientUsername();if(i)return!1;i=!0;const n=await s.wait("#chat-content");return r=new MutationObserver(async n=>{for(const s of n)for(const n of s.addedNodes){if(!(n instanceof HTMLElement))continue;const s=n.querySelector("b");if(!s){t.log("skip: no <b>",n);continue}const r=s.querySelectorAll(".user-badge-small"),a=r.length?[...r].map(e=>({img:e.querySelector("img")?.getAttribute("src")||null,text:e.querySelector(".tooltip")?.textContent.trim()||null})):[],i=s.querySelectorAll("bdi"),c=s.querySelector("span"),l=s.textContent.replace(/\s+/g," ").trim(),u=[...n.childNodes].filter(e=>e.nodeType===Node.TEXT_NODE).map(e=>e.textContent).join("").trim(),d=s.classList.contains("warning")||l.startsWith("WARNING:"),p=!!i[0],m=l.includes(":"),g=p&&m&&!d,h=!g&&!d,f=g?i[0]?.textContent||"unknown":null,y=g?c?.textContent||"Guest":null,w={trusted:!1,timestamp:Date.now(),raw:l,isUser:g,isSystem:h};if(t.log("parsed",{userMessage:u,rawText:l,isUser:g,isSystem:h}),d)t.log("emit warning",w),o.emit("warning",w);else{if(h&&"SYSTEM"===c?.textContent&&l.includes("New mission:")){const e=l.includes("NOW"),n=l.split("New mission:")[1]?.split(".")[0]?.trim()||"",s=l.match(/in (.*?) (NOW|in)/)?.[1]||"";t.log("emit mission",{name:n,location:s,isOpen:e}),o.emit("mission",{...w,name:n,location:s,isOpen:e});continue}if(h&&(l.includes("was promoted to")||l.includes("was demoted to")))i.length>=2&&(t.log("emit roleChange",{targetUser:i[0].textContent,byUser:i[1].textContent}),o.emit("roleChange",{...w,targetUser:i[0].textContent,byUser:i[1].textContent,newRole:c?.textContent||null}));else{if(g){f===e&&await new Promise(e=>setTimeout(e,1e3));const n=u;if(!n){t.log("skip empty message",l);continue}t.log("emit chat",{user:f,role:y,message:n}),o.emit("chat",{...w,user:f,role:y,message:n,badges:a});continue}if(h&&l.includes("joined the ship.")){const e=i[0]?.textContent||"unknown";t.log("emit shipJoin",e),o.emit("shipJoin",{...w,user:e,role:y,badges:a});continue}if(h&&l.includes("left the ship.")){const e=i[0]?.textContent||"unknown";t.log("emit shipLeave",e),o.emit("shipLeave",{...w,user:e,role:y,badges:a});continue}t.log("unhandled line",l)}}}}),r.observe(n,{childList:!0}),!0},destroy:()=>!!i&&(r?.disconnect(),r=null,i=!1,!0)})})(),m=(()=>{deprecate("Outfit API is no longer work. please stop using it");let e=!1,t=null,n=null,o=!1,s=!1;return Object.freeze({initWsHook:r=>{if(deprecate("Outfit API is no longer work. please stop using it"),"loading"!==document.readyState)return;if(e)return;if("string"!=typeof r||!r)return;n=r,(()=>{if(window.msgpack)return void(o=!0);if(s)return;s=!0;const e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/@msgpack/msgpack/dist/msgpack.min.js",e.onload=()=>{o=!0},e.onerror=()=>{s=!1},document.documentElement.appendChild(e)})();const a=window.postMessage;window.postMessage=function(o,s,...r){return!e&&o?.message===n&&o?.wsData&&(t=e=>a.call(this,{message:n,wsData:e},s),e=!0),a.call(this,o,s,...r)},console.log(!0)},setOutfit:(n,s)=>{if(deprecate("Outfit API is no longer work. please stop using it"),!s||"object"!=typeof s)return;if(n){if(!e||!o)return;return t(window.msgpack.encode({type:7,outfit:s})),!0}const r=(()=>{try{return JSON.parse(localStorage.getItem("dredark_user_settings"))||{}}catch{return{}}})();return r.player_appearance=s,localStorage.setItem("dredark_user_settings",JSON.stringify(r)),!0}})})(),Dreddark={defaultCommandPrefix:e,version:"2.1.9",rankValue:n,debug:t,outfit:m,events:o,chat:p,ship:i,commands:l,mission:u,pvpEvent:d,observe:s,defaultStorageOption:c.storageOption,storage:c,utils:r,use(e){try{e(Dreddark)}catch{}},client:a};root.Dreddark=Dreddark})();